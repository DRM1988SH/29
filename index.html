<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>نظام إدخال الذبائح اليومية</title>

<!-- أيقونات -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
  :root{
    --w:1500px;
    --bg:#f6ede4;           /* بني فاتح جداً */
    --card:#fff;
    --text:#3b2e2a;
    --muted:#6b5b53;
    --primary:#1976d2;
    --success:#2e7d32;
    --warning:#f9a825;
    --danger:#c62828;
    --pink:#ad1457;
    --purple:#6a1b9a;
    --teal:#00695c;
    --border:#ddcfc5;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Tajawal", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
  }
  .app{
    max-width: var(--w);
    margin: 0 auto;
    padding: 16px;
  }
  header{
    display:flex; align-items:center; gap:12px; margin-bottom:12px;
  }
  header img.brand{
    height:48px; width:auto; object-fit:contain; border-radius:8px;
  }
  header h1{ font-size:22px; margin:0; }
  .bar{
    display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 18px;
  }
  button{
    border:none; padding:10px 14px; border-radius:10px; cursor:pointer;
    color:#fff; font-weight:600; display:inline-flex; align-items:center; gap:8px;
    box-shadow: 0 2px 6px rgba(0,0,0,.08);
  }
  .b-blue{ background:var(--primary) } .b-green{ background:var(--success) }
  .b-amber{ background:var(--warning) } .b-red{ background:var(--danger) }
  .b-pink{ background:var(--pink) } .b-purple{ background:var(--purple) }
  .b-teal{ background:var(--teal) } .b-gray{ background:#607d8b }
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    padding:16px; margin:12px 0;
  }
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .row-3{ display:grid; grid-template-columns: repeat(3,1fr); gap:12px; }
  .row-4{ display:grid; grid-template-columns: repeat(4,1fr); gap:12px; }
  label{ font-size:14px; color:var(--muted); display:block; margin-bottom:6px; }
  input, select, textarea{
    width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; font-size:15px; background:#fff;
  }
  input[type="number"]{ direction:ltr; text-align:right; }
  .screen{ display:none; }
  .screen.active{ display:block; }
  .left-image{
    width:150px; height:200px; object-fit:cover; border-radius:10px; border:1px solid var(--border);
  }
  .center-title{
    text-align:center; font-size:24px; font-weight:800; margin:8px 0 16px;
  }
  table{
    width:100%; border-collapse:collapse; background:#fff; border:1px solid var(--border); border-radius:10px; overflow:hidden;
  }
  th, td{ padding:10px; border-bottom:1px solid var(--border); font-size:14px; }
  th{ background:#efe4da; text-align:center; }
  td{ vertical-align:middle; }
  .tbl-wrap{ overflow:auto; border-radius:10px; border:1px solid var(--border); }
  .hint{ font-size:12px; color:var(--muted); }
  .flex{ display:flex; align-items:center; gap:12px; }
  .between{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .mt{ margin-top:12px }
  .mb{ margin-bottom:12px }
  .center{ text-align:center }
  .hidden{ display:none }

  /* شاشة الترحيب */
  .splash{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:var(--bg); z-index:9999;
  }
  .splash .box{
    width: min(92vw, var(--w)); height: 320px; border:1px solid var(--border);
    background:#fff; border-radius:18px; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:18px;
  }
  .splash img{ height:200px; object-fit:contain; border-radius:12px; }
  .splash h2{ margin:0; }

  /* الطباعة العامة – نطبع المحتوى فقط */
  @media print{
    body{ background:#fff }
    .no-print{ display:none !important }
    .print-only{ display:block !important }
  }

  /* فاتورة – ورقة عادية بقياس A4 افتراضياً */
  .invoice{
    width: 190mm; margin:0 auto; padding:12mm; font-size:14px; line-height:1.6; color:#000;
  }
  .invoice h2{ text-align:center; margin:0 0 8px }
  .invoice .head{
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;
  }
  .invoice .head img{ height:60px; width:auto; object-fit:contain; }

  /* بطاقة غذائية – Zebra ZT-230: 9.701in × 1.907in */
  .food-label-wrapper{
    width: 9.701in;
    height: 1.907in;
    border:2px solid #000;
    padding:0.06in;
    display:grid;
    grid-template-columns: 1fr 1fr 1fr auto; /* عمود للاستكر الكبير في الطرف */
    grid-auto-rows: 1fr;
    gap: 0.06in;
    align-items:stretch;
  }
  .food-label img.logo{
    height:0.6in; width:auto; object-fit:contain;
  }
  .food-label .plant-name{ font-weight:800; margin-top:2px; }
  .food-label .box, .food-label .box .val{
    border:1px solid #000; padding:0.04in; font-size:12pt; line-height:1.05;
  }
  .food-label .box .ttl{ font-weight:700; margin-bottom:2px; }
  .food-label .sticker{
    border:2px solid #000; display:flex; align-items:center; justify-content:center;
    font-weight:900; font-size:28pt; padding:0.02in; writing-mode:horizontal-tb;
  }
  .food-footer{ font-size:9pt; margin-top:4px; text-align:center }

  /* لضبط صفحة الطباعة للبطاقة على القياس المحدد */
  @media print{
    .food-label-page{ width: 9.701in; height: 1.907in; }
    .food-label-page{ page-break-after: avoid; }
    @page{
      size: 9.701in 1.907in;
      margin: 0.1in;
    }
  }

  /* تجاوب للجوال */
  @media (max-width: 900px){
    .row, .row-3, .row-4{ grid-template-columns: 1fr; }
    .left-image{ width:100%; height:180px }
  }
</style>
</head>
<body>

<!-- شاشة ترحيب -->
<div id="splash" class="splash">
  <div class="box center">
    <img id="splashImg" alt="صورة الترحيب"
      src="https://static.vecteezy.com/system/resources/previews/043/524/239/non_2x/camel-head-silhouette-without-background-vector.jpg">
    <h2>مرحباً بك في نظام الذبائح</h2>
    <div class="hint">سيتم الانتقال تلقائياً…</div>
  </div>
</div>

<div class="app">

  <header class="no-print">
    <img id="brandImg" class="brand" alt="شعار" src="">
    <h1>نظام إدخال الذبائح اليومية</h1>
    <span class="hint">HTML • CSS • JS</span>
  </header>

  <!-- شريط التنقل -->
  <div class="bar no-print" id="topBar" style="display:none">
    <button class="b-blue"  onclick="go('screenDashboard')"><i class="fa-solid fa-gauge"></i> شاشة التحكم</button>
    <button class="b-green" onclick="go('screenEntry')"><i class="fa-solid fa-plus"></i> الإدخال</button>
    <button class="b-purple" onclick="go('screenClients')"><i class="fa-solid fa-users"></i> تقرير المتعاملين</button>
    <button class="b-amber" onclick="go('screenStats')"><i class="fa-solid fa-chart-column"></i> الإحصاء والمالية</button>
    <button class="b-teal" onclick="go('screenInvoices')"><i class="fa-solid fa-file-invoice"></i> الفواتير</button>
    <button class="b-pink" onclick="go('screenSettings')"><i class="fa-solid fa-gear"></i> الإعدادات</button>
    <button class="b-gray" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> خروج</button>
  </div>

  <!-- شاشة تسجيل الدخول -->
  <section id="screenLogin" class="screen card active">
    <div class="center">
      <img id="loginImg" alt="صورة تسجيل الدخول" style="height:200px;border-radius:12px;border:1px solid var(--border);object-fit:contain">
      <h2>تسجيل الدخول</h2>
    </div>
    <div class="row center">
      <div style="margin:auto; max-width:420px; width:100%">
        <label>الرقم الوظيفي</label>
        <input id="empId" type="password" placeholder="أدخل الرقم الوظيفي (70062)" inputmode="numeric">
        <div class="mt between">
          <span class="hint">يفضل العرض 1500px على الكمبيوتر – متوافق مع الجوال</span>
          <button class="b-blue" onclick="login()"><i class="fa-solid fa-right-to-bracket"></i> دخول</button>
        </div>
      </div>
    </div>
  </section>

  <!-- شاشة التحكم -->
  <section id="screenDashboard" class="screen card">
    <div class="center-title">لوحة التحكم</div>
    <div class="row-3">
      <button class="b-green" onclick="go('screenEntry')"><i class="fa-solid fa-plus"></i> الإدخال</button>
      <button class="b-purple" onclick="go('screenClients')"><i class="fa-solid fa-users"></i> تقرير المتعاملين</button>
      <button class="b-amber" onclick="go('screenStats')"><i class="fa-solid fa-chart-pie"></i> الإحصاء والمالية</button>
      <button class="b-teal" onclick="go('screenInvoices')"><i class="fa-solid fa-receipt"></i> الفواتير</button>
      <button class="b-pink" onclick="go('screenSettings')"><i class="fa-solid fa-gear"></i> الإعدادات</button>
    </div>
  </section>

  <!-- شاشة الإدخال -->
  <section id="screenEntry" class="screen card">
    <div class="between mb">
      <div class="flex">
        <img id="entryImg" class="left-image" alt="صورة الإدخال">
        <div>
          <div class="center-title">إدخال الذبائح اليومية</div>
          <div class="hint" id="nowInfo"></div>
        </div>
      </div>
      <div style="text-align:left">
        <button class="b-green" onclick="addItem()"><i class="fa-solid fa-plus"></i> إضافة ذبيحة</button>
        <button class="b-blue" onclick="printInvoice()"><i class="fa-solid fa-print"></i> طباعة فاتورة</button>
        <button class="b-amber" onclick="printFoodLabel()"><i class="fa-solid fa-qrcode"></i> طباعة البطاقة الغذائية</button>
      </div>
    </div>

    <div class="row-4">
      <div>
        <label>التاريخ والساعة</label>
        <input id="dt" type="datetime-local">
      </div>
      <div>
        <label>الموقع</label>
        <select id="site"></select>
      </div>
      <div>
        <label>رقم الهاتف</label>
        <input id="phone" type="tel" placeholder="05xxxxxxxx">
      </div>
      <div>
        <label>اسم المتعامل</label>
        <input id="client" type="text" placeholder="سيظهر تلقائياً إن كان مسجلاً">
      </div>
    </div>

    <div class="row-4 mt">
      <div>
        <label>بادئة رقم الفاتورة</label>
        <input id="invPrefix" type="text" placeholder="مثال: ZY-">
      </div>
      <div>
        <label>رقم الفاتورة</label>
        <input id="invNo" type="text" placeholder="سيتولد تلقائياً إن تركته فارغاً">
      </div>
      <div>
        <label>رقم الذبيحة</label>
        <input id="animalNo" type="text" placeholder="مثال: 2025-001">
      </div>
      <div>
        <label>رقم الاستيكر</label>
        <select id="sticker"></select>
      </div>
    </div>

    <div class="row-4 mt">
      <div>
        <label>نوع الذبيحة</label>
        <select id="animalType"></select>
      </div>
      <div>
        <label>نوع التقطيع</label>
        <select id="cutType"></select>
      </div>
      <div>
        <label>السعر (درهم)</label>
        <input id="price" type="number" min="0" step="0.5" value="0">
      </div>
      <div>
        <label>العدد</label>
        <select id="qty"></select>
      </div>
    </div>

    <div class="row mt">
      <div>
        <label>الإجمالي (درهم)</label>
        <input id="total" type="number" readonly>
      </div>
      <div>
        <label>ملحقات</label>
        <select id="extras">
          <option value="">—</option>
          <option>كرش مصران كوارع</option>
          <option>كوارع</option>
          <option>كرش مصران</option>
        </select>
      </div>
      <div>
        <label>طريقة الدفع</label>
        <select id="payMethod">
          <option>بطاقة</option>
          <option>كاش</option>
        </select>
      </div>
      <div class="flex">
        <div class="hint">يتم حفظ المدخلات عند الضغط على "إضافة ذبيحة"</div>
      </div>
    </div>

    <div class="tbl-wrap mt">
      <table id="entryTable">
        <thead>
          <tr>
            <th>#</th><th>التاريخ</th><th>الموقع</th><th>الهاتف</th><th>المتعامل</th>
            <th>فاتورة</th><th>رقم ذبيحة</th><th>استيكر</th>
            <th>النوع</th><th>التقطيع</th><th>العدد</th><th>السعر</th><th>الإجمالي</th><th>ملحقات</th><th>دفع</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- شاشة تقرير المتعاملين -->
  <section id="screenClients" class="screen card">
    <div class="between">
      <div class="flex">
        <img id="clientsImg" class="left-image" alt="صورة التقرير">
        <div class="center-title">تقرير المتعاملين</div>
      </div>
      <div>
        <button class="b-blue" onclick="printSection('clientsPrint')"><i class="fa-solid fa-print"></i> طباعة / PDF</button>
      </div>
    </div>
    <div class="row-4">
      <div>
        <label>الموقع</label>
        <select id="clientsSite"></select>
      </div>
      <div>
        <label>من تاريخ</label>
        <input id="clientsFrom" type="date">
      </div>
      <div>
        <label>إلى تاريخ</label>
        <input id="clientsTo" type="date">
      </div>
      <div class="flex" style="align-items:flex-end">
        <button class="b-green" onclick="refreshClients()"><i class="fa-solid fa-filter"></i> تطبيق الفلتر</button>
      </div>
    </div>
    <div id="clientsPrint" class="mt">
      <div class="between no-print">
        <div></div>
      </div>
      <div class="tbl-wrap">
        <table id="clientsTable">
          <thead>
            <tr>
              <th>م</th><th>التاريخ</th><th>اسم المتعامل</th><th>رقم التلفون</th><th>نوع الذبيحة</th><th>نوع التقطيع</th><th>رقم الفاتورة</th><th>العدد</th><th>السعر</th><th>الإجمالي</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- شاشة تقرير الإحصاء والمالية -->
  <section id="screenStats" class="screen card">
    <div class="between">
      <div class="flex">
        <img id="statsImg" class="left-image" alt="صورة الإحصاء">
        <div class="center-title">تقرير الإحصاء والمالية</div>
      </div>
      <div>
        <button class="b-blue" onclick="printSection('statsPrint')"><i class="fa-solid fa-print"></i> طباعة / PDF</button>
      </div>
    </div>
    <div class="row-4">
      <div>
        <label>الموقع</label>
        <select id="statsSite"></select>
      </div>
      <div>
        <label>من تاريخ</label>
        <input id="statsFrom" type="date">
      </div>
      <div>
        <label>إلى تاريخ</label>
        <input id="statsTo" type="date">
      </div>
      <div class="flex" style="align-items:flex-end">
        <button class="b-green" onclick="refreshStats()"><i class="fa-solid fa-filter"></i> تطبيق الفلتر</button>
      </div>
    </div>

    <div id="statsPrint" class="mt">
      <div class="tbl-wrap">
        <table id="statsTable">
          <thead>
            <tr>
              <th>نوع الذبيحة</th><th>نوع التقطيع</th><th>عدد الذبائح</th><th>العدد الكلي</th><th>المبلغ الإجمالي</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- شاشة الفواتير -->
  <section id="screenInvoices" class="screen card">
    <div class="between">
      <div class="center-title">الفواتير</div>
      <div class="flex">
        <input id="invSearchPhone" type="tel" placeholder="بحث برقم الهاتف">
        <button class="b-green" onclick="searchInvoices()"><i class="fa-solid fa-magnifying-glass"></i> بحث</button>
      </div>
    </div>
    <div class="tbl-wrap">
      <table id="invoiceTable">
        <thead>
          <tr>
            <th>التاريخ</th><th>رقم الفاتورة</th><th>رقم الذبيحة</th><th>الاستيكر</th>
            <th>نوع الذبيحة</th><th>التقطيع</th><th>العدد</th><th>السعر</th><th>الإجمالي</th><th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="hint">تعديل الفاتورة متاح لــ "المشرف".</div>
  </section>

  <!-- شاشة الإعدادات -->
  <section id="screenSettings" class="screen card">
    <div class="center-title">الإعدادات</div>

    <div class="card">
      <h3>المستخدمون</h3>
      <div class="row-4">
        <div><label>الرقم الوظيفي</label><input id="setUserId" placeholder="مثال: 70062"></div>
        <div><label>الدور</label><select id="setRole"><option>مشرف</option><option>مستخدم</option></select></div>
        <div class="flex" style="align-items:flex-end"><button class="b-green" onclick="addUser()"><i class="fa-solid fa-user-plus"></i> إضافة</button></div>
      </div>
      <div class="tbl-wrap mt"><table id="usersTable"><thead><tr><th>الرقم</th><th>الدور</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="card">
      <h3>المواقع والبادئة</h3>
      <div class="row-4">
        <div><label>الموقع</label><input id="setSite" placeholder="اسم الموقع"></div>
        <div><label>البادئة</label><input id="setPrefix" placeholder="مثال: ZY-"></div>
        <div class="flex" style="align-items:flex-end"><button class="b-green" onclick="addSite()"><i class="fa-solid fa-location-dot"></i> إضافة</button></div>
      </div>
      <div class="tbl-wrap mt"><table id="sitesTable"><thead><tr><th>الموقع</th><th>البادئة</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="card">
      <h3>إعداد الذبائح والتقطيع والأسعار</h3>
      <div class="row-4">
        <div>
          <label>نوع الذبيحة</label>
          <select id="setAnimal">
            <option>خروف</option><option>ماعز</option><option>عجل صغير</option><option>بقر</option><option>حوار صغير</option><option>جمل</option><option>أخرى…</option>
          </select>
          <input id="setAnimalOther" class="mt hidden" placeholder="أدخل النوع الآخر">
        </div>
        <div>
          <label>نوع التقطيع</label>
          <select id="setCut"><option>كامل</option><option>عزيمة</option><option>ثلاجة</option></select>
        </div>
        <div>
          <label>السعر (درهم)</label>
          <input id="setPrice" type="number" min="0" step="0.5">
        </div>
        <div class="flex" style="align-items:flex-end">
          <button class="b-green" onclick="addPriceMap()"><i class="fa-solid fa-tag"></i> إضافة/تحديث</button>
        </div>
      </div>
      <div class="tbl-wrap mt"><table id="pricesTable"><thead><tr><th>الذبيحة</th><th>التقطيع</th><th>السعر</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="card">
      <h3>إعداد الصور (ترفع من الملفات)</h3>
      <div class="row-4">
        <div><label>صورة شاشة الترحيب</label><input type="file" accept="image/*" onchange="uploadImage(event,'splash')"></div>
        <div><label>صورة تسجيل الدخول</label><input type="file" accept="image/*" onchange="uploadImage(event,'login')"></div>
        <div><label>صورة شاشة الإدخال</label><input type="file" accept="image/*" onchange="uploadImage(event,'entry')"></div>
        <div><label>صورة تقرير المتعاملين</label><input type="file" accept="image/*" onchange="uploadImage(event,'clients')"></div>
        <div><label>صورة تقرير الإحصاء</label><input type="file" accept="image/*" onchange="uploadImage(event,'stats')"></div>
        <div><label>صورة البطاقة الغذائية</label><input type="file" accept="image/*" onchange="uploadImage(event,'label')"></div>
        <div><label>شعار أعلى الصفحة</label><input type="file" accept="image/*" onchange="uploadImage(event,'brand')"></div>
      </div>
      <div class="hint mt">يتم عرض الصور بارتفاع 200 للشاشات. صورة البطاقة الغذائية تُدرج داخل تصميم البطاقة.</div>
    </div>
  </section>

  <!-- قوالب الطباعة (مخفية على الشاشة) -->
  <div id="printArea" class="print-only hidden"></div>

</div>

<script>
/* ============= البيانات المؤقتة (داخل الذاكرة) ============= */
const state = {
  logged:false,
  role:'مستخدم',
  currentScreen:'screenLogin',
  settings:{
    splashImg: "https://static.vecteezy.com/system/resources/previews/043/524/239/non_2x/camel-head-silhouette-without-background-vector.jpg",
    loginImg: "",
    entryImg: "",
    clientsImg: "",
    statsImg: "",
    labelImg: "",
    brandImg: "",
    sites:[
      {name:"مسلخ مدينة زايد", prefix:"ZY-"},
      {name:"مسلخ مدينة ليوا", prefix:"LW-"},
      {name:"مسلخ مدينة المرفأ", prefix:"MR-"},
      {name:"مسلخ مدينة غياثي", prefix:"GY-"},
      {name:"مسلخ مدينة السلع", prefix:"SL-"},
      {name:"مسلخ مدينة دلما", prefix:"DL-"},
      {name:"المسلخ المتنقل 1", prefix:"MV1-"},
      {name:"المسلخ المتنقل 2", prefix:"MV2-"},
    ],
    priceMap: { /* key: animal|cut -> price */ },
    users: [{id:'70062', role:'مشرف'}],
  },
  items:[],    // سجلات الإدخال
  clientsIndex:{} // phone -> name
};

/* ============= أدوات مساعدة ============= */
const $ = sel => document.querySelector(sel);
const pad = n => String(n).padStart(2,'0');
const fmtDateTime = iso => {
  const d = new Date(iso);
  const y=d.getFullYear(), m=pad(d.getMonth()+1), dd=pad(d.getDate());
  const hh=pad(d.getHours()), mm=pad(d.getMinutes());
  return `${y}-${m}-${dd} ${hh}:${mm}`;
};
const todayISO = () => {
  const d = new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
  return d.toISOString().slice(0,16);
};
const dateOnly = iso => iso.slice(0,10);

/* حفظ الشاشة الحالية بالجلسة ليبقى بعد التحديث */
function saveSession(){
  sessionStorage.setItem('appState', JSON.stringify({
    currentScreen: state.currentScreen,
    settings: state.settings,
    logged: state.logged,
    role: state.role
  }));
}
function loadSession(){
  const s = sessionStorage.getItem('appState');
  if(!s) return;
  try{
    const obj = JSON.parse(s);
    state.currentScreen = obj.currentScreen || state.currentScreen;
    state.settings = obj.settings || state.settings;
    state.logged = obj.logged || false;
    state.role = obj.role || 'مستخدم';
  }catch(e){}
}

/* ============= تهيئة الواجهات ============= */
function init(){
  loadSession();

  // صور الواجهة
  $('#splashImg').src = state.settings.splashImg || '';
  $('#loginImg').src  = state.settings.loginImg  || '';
  $('#entryImg').src  = state.settings.entryImg  || '';
  $('#clientsImg').src= state.settings.clientsImg|| '';
  $('#statsImg').src  = state.settings.statsImg  || '';
  $('#brandImg').src  = state.settings.brandImg  || '';

  // تعبئة القوائم
  fillSites($('#site'));
  fillSites($('#clientsSite'));
  fillSites($('#statsSite'));

  fillAnimalAndCutLists();
  fillStickerList();
  fillQtyList();

  $('#dt').value = todayISO();
  $('#nowInfo').textContent = new Date().toLocaleString('ar-EG');

  // إظهار شريط التنقل إذا داخلين
  if(state.logged){
    $('#topBar').style.display = 'flex';
    go(state.currentScreen || 'screenDashboard', true);
  }else{
    go('screenLogin', true);
  }

  setTimeout(()=>{ $('#splash').style.display='none'; }, 500);
}
document.addEventListener('DOMContentLoaded', init);

/* ============= تنقل الشاشات ============= */
function go(id, silent=false){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  $('#'+id).classList.add('active');
  state.currentScreen = id;
  if(!silent) saveSession();
}
function logout(){
  state.logged=false; saveSession(); location.reload();
}

/* ============= تسجيل الدخول ============= */
function login(){
  const id = $('#empId').value.trim();
  const ok = state.settings.users.some(u=>u.id===id);
  if(ok){
    const u = state.settings.users.find(u=>u.id===id);
    state.role = u.role;
    state.logged=true;
    $('#topBar').style.display='flex';
    saveSession();
    go('screenDashboard');
  }else{
    alert('رقم وظيفي غير صحيح');
  }
}

/* ============= تعبئة القوائم ============= */
function fillSites(sel){
  sel.innerHTML = '';
  state.settings.sites.forEach(s=>{
    const o=document.createElement('option'); o.textContent=s.name; o.value=s.name; sel.appendChild(o);
  });
}
function fillAnimalAndCutLists(){
  const animals = ["خروف","ماعز","عجل صغير","بقر","حوار صغير","جمل"];
  const cuts = ["كامل","عزيمة","ثلاجة"];
  const aSel = $('#animalType'), cSel = $('#cutType');
  aSel.innerHTML=''; cSel.innerHTML='';
  animals.forEach(x=>{ const o=document.createElement('option'); o.textContent=x; aSel.appendChild(o); });
  cuts.forEach(x=>{ const o=document.createElement('option'); o.textContent=x; cSel.appendChild(o); });
}
function fillStickerList(){
  const sel=$('#sticker'); sel.innerHTML='';
  for(let i=1;i<=1000;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; sel.appendChild(o); }
}
function fillQtyList(){
  const sel=$('#qty'); sel.innerHTML='';
  for(let i=1;i<=1000;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; sel.appendChild(o); }
}

/* ============= حسابات السعر والإجمالي ============= */
['animalType','cutType'].forEach(id=>{
  $('#'+id).addEventListener('change', ()=>{
    const key = $('#animalType').value+'|'+$('#cutType').value;
    if(state.settings.priceMap[key]!=null){
      $('#price').value = state.settings.priceMap[key];
      calcTotal();
    }
  });
});
['price','qty'].forEach(id=> $('#'+id).addEventListener('input', calcTotal));
function calcTotal(){
  const p = parseFloat($('#price').value||0);
  const q = parseInt($('#qty').value||1);
  $('#total').value = (p*q).toFixed(2);
}

/* ============= توليد رقم فاتورة ============= */
function generateInvNo(){
  const siteName = $('#site').value;
  const site = state.settings.sites.find(s=>s.name===siteName);
  const prefix = $('#invPrefix').value || (site? site.prefix : '');
  const seq = String(state.items.length+1).padStart(5,'0');
  return `${prefix}${new Date().getFullYear()}-${seq}`;
}

/* ============= إضافة ذبيحة ============= */
function addItem(){
  const dt = $('#dt').value || todayISO();
  const site = $('#site').value;
  const phone = $('#phone').value.trim();
  const client = $('#client').value.trim();
  const invNo = $('#invNo').value.trim() || generateInvNo();
  const invPrefix = $('#invPrefix').value.trim();
  const animalNo = $('#animalNo').value.trim();
  const sticker = parseInt($('#sticker').value);
  const animal = $('#animalType').value;
  const cut = $('#cutType').value;
  const price = parseFloat($('#price').value||0);
  const qty = parseInt($('#qty').value||1);
  const total = parseFloat($('#total').value||0);
  const extras = $('#extras').value;
  const pay = $('#payMethod').value;

  if(!site){ alert('اختر الموقع'); return; }
  if(!phone){ alert('أدخل رقم الهاتف'); return; }
  if(!client){ alert('أدخل اسم المتعامل'); return; }
  if(!animalNo){ alert('أدخل رقم الذبيحة'); return; }

  // فهرس المتعاملين حسب رقم الهاتف
  state.clientsIndex[phone] = client;

  const item = {dt, site, phone, client, invNo, invPrefix, animalNo, sticker, animal, cut, price, qty, total, extras, pay};
  state.items.push(item);
  appendEntryRow(item);
  $('#invNo').value = invNo; // يظل ثابتاً للفاتورة الحالية
}

/* استدعاء اسم المتعامل إن وُجد */
$('#phone').addEventListener('change', ()=>{
  const p = $('#phone').value.trim();
  if(state.clientsIndex[p]) $('#client').value = state.clientsIndex[p];
});

/* ============= جدول الإدخال ============= */
function appendEntryRow(it){
  const tb = $('#entryTable tbody');
  const tr = document.createElement('tr');
  const idx = state.items.indexOf(it)+1;
  tr.innerHTML = `
    <td>${idx}</td><td>${fmtDateTime(it.dt)}</td><td>${it.site}</td><td>${it.phone}</td><td>${it.client}</td>
    <td>${it.invNo}</td><td>${it.animalNo}</td><td>${it.sticker}</td>
    <td>${it.animal}</td><td>${it.cut}</td><td>${it.qty}</td><td>${it.price.toFixed(2)}</td><td>${it.total.toFixed(2)}</td>
    <td>${it.extras||''}</td><td>${it.pay}</td>
  `;
  tb.appendChild(tr);
}

/* ============= التقارير ============= */
function filterBySiteAndDate(items, site, from, to){
  const f = from ? new Date(from) : null;
  const t = to ? new Date(to) : null;
  return items.filter(it=>{
    if(site && it.site!==site) return false;
    const d = new Date(it.dt);
    if(f && d < new Date(f.toDateString())) return false;
    if(t && d > new Date(new Date(t).toDateString()+" 23:59:59")) return false;
    return true;
  });
}
/* تقرير المتعاملين */
function refreshClients(){
  const site = $('#clientsSite').value;
  const from = $('#clientsFrom').value;
  const to   = $('#clientsTo').value;
  const rows = filterBySiteAndDate(state.items, site, from, to);
  const tb = $('#clientsTable tbody'); tb.innerHTML='';
  rows.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td><td>${fmtDateTime(it.dt)}</td><td>${it.client}</td><td>${it.phone}</td>
      <td>${it.animal}</td><td>${it.cut}</td><td>${it.invNo}</td><td>${it.qty}</td>
      <td>${it.price.toFixed(2)}</td><td>${it.total.toFixed(2)}</td>
    `;
    tb.appendChild(tr);
  });
}
/* تقرير الإحصاء والمالية */
function refreshStats(){
  const site = $('#statsSite').value;
  const from = $('#statsFrom').value;
  const to   = $('#statsTo').value;
  const rows = filterBySiteAndDate(state.items, site, from, to);
  const map = {}; // key: animal|cut -> {animal,cut,count,qtySum,total}
  rows.forEach(it=>{
    const k = it.animal+'|'+it.cut;
    if(!map[k]) map[k]={animal:it.animal, cut:it.cut, count:0, qtySum:0, total:0};
    map[k].count += 1;
    map[k].qtySum += it.qty;
    map[k].total += it.total;
  });
  const tb = $('#statsTable tbody'); tb.innerHTML='';
  Object.values(map).forEach(o=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${o.animal}</td><td>${o.cut}</td><td>${o.count}</td><td>${o.qtySum}</td><td>${o.total.toFixed(2)}</td>`;
    tb.appendChild(tr);
  });
}

/* ============= الفواتير: بحث/تعديل/طباعة ============= */
function searchInvoices(){
  const phone = $('#invSearchPhone').value.trim();
  const rows = state.items.filter(x=> x.phone===phone);
  const tb = $('#invoiceTable tbody'); tb.innerHTML='';
  rows.forEach((it, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtDateTime(it.dt)}</td>
      <td><input data-bind="invNo" value="${it.invNo}" ${state.role==='مشرف'?'':'readonly'}></td>
      <td><input data-bind="animalNo" value="${it.animalNo}" ${state.role==='مشرف'?'':'readonly'}></td>
      <td><input data-bind="sticker" value="${it.sticker}" ${state.role==='مشرف'?'':'readonly'}></td>
      <td><input data-bind="animal" value="${it.animal}" ${state.role==='مشرف'?'':'readonly'}></td>
      <td><input data-bind="cut" value="${it.cut}" ${state.role==='مشرف'?'':'readonly'}></td>
      <td><input type="number" data-bind="qty" value="${it.qty}" ${state.role==='مشرف'?'':'readonly'}></td>
      <td><input type="number" step="0.5" data-bind="price" value="${it.price}" ${state.role==='مشرف'?'':'readonly'}></td>
      <td>${(it.qty*it.price).toFixed(2)}</td>
      <td>
        <button class="b-green" onclick="doPrintInvoiceByIndex(${getIndex(it)})"><i class="fa-solid fa-print"></i></button>
        ${state.role==='مشرف'?`<button class="b-amber" onclick="applyEdit(this, ${getIndex(it)})"><i class="fa-solid fa-floppy-disk"></i></button>`:''}
      </td>
    `;
    tb.appendChild(tr);
  });
}
function getIndex(it){ return state.items.indexOf(it); }
function applyEdit(btn, idx){
  const tr = btn.closest('tr');
  const inputs = tr.querySelectorAll('input[data-bind]');
  inputs.forEach(inp=>{
    state.items[idx][inp.dataset.bind] = (inp.type==='number')? parseFloat(inp.value): inp.value;
  });
  state.items[idx].total = state.items[idx].qty * state.items[idx].price;
  searchInvoices(); // إعادة رسم
}

/* ============= الطباعة العامة ============= */
function printSection(containerId){
  // تجهيز ترويسة التقرير (عنوان وسط + صورة يسار)
  const imgSrc = (containerId==='clientsPrint')? state.settings.clientsImg : state.settings.statsImg;
  const title = (containerId==='clientsPrint')? 'تقرير المتعاملين' : 'تقرير الإحصاء والمالية';
  const el = document.getElementById(containerId).cloneNode(true);
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <div style="text-align:center;font-weight:800;font-size:18px;margin-bottom:8px">${title}</div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div></div>
      <img src="${imgSrc||state.settings.brandImg||''}" style="height:60px;object-fit:contain">
    </div>
  `;
  wrap.appendChild(el);
  doPrintHtml(wrap.innerHTML);
}
function doPrintHtml(html){
  const printArea = $('#printArea');
  printArea.innerHTML = html;
  printArea.classList.remove('hidden');
  window.print();
  setTimeout(()=>{ printArea.classList.add('hidden'); printArea.innerHTML=''; }, 200);
}

/* ============= طباعة الفاتورة ============= */
function buildInvoiceHTML(it){
  const siteTitle = it.site || '';
  const logo = state.settings.brandImg || state.settings.entryImg || '';
  return `
    <div class="invoice">
      <div class="head">
        <img src="${logo}" alt="">
        <div style="text-align:center; flex:1">
          <h2>فاتورة</h2>
          <div>${siteTitle}</div>
        </div>
        <div></div>
      </div>
      <table style="width:100%; border-collapse:collapse" border="1" cellpadding="6">
        <tbody>
          <tr><td style="width:35%"><b>التاريخ</b></td><td>${fmtDateTime(it.dt)}</td></tr>
          <tr><td><b>رقم الفاتورة</b></td><td>${it.invNo}</td></tr>
          <tr><td><b>رقم الذبيحة</b></td><td>${it.animalNo}</td></tr>
          <tr><td><b>رقم الاستيكر</b></td><td>${it.sticker}</td></tr>
          <tr><td><b>نوع الذبيحة</b></td><td>${it.animal}</td></tr>
          <tr><td><b>نوع التقطيع</b></td><td>${it.cut}</td></tr>
          <tr><td><b>العدد</b></td><td>${it.qty}</td></tr>
          <tr><td><b>السعر</b></td><td>${it.price.toFixed(2)}</td></tr>
          <tr><td><b>الإجمالي</b></td><td>${(it.price*it.qty).toFixed(2)}</td></tr>
        </tbody>
      </table>
    </div>
  `;
}
function printInvoice(){
  if(state.items.length===0){ alert('لا توجد بيانات مدخلة'); return; }
  const it = state.items[state.items.length-1];
  doPrintHtml(buildInvoiceHTML(it));
}
function doPrintInvoiceByIndex(idx){
  const it = state.items[idx];
  doPrintHtml(buildInvoiceHTML(it));
}

/* ============= طباعة البطاقة الغذائية (Zebra ZT-230) ============= */
function is14day(animal){
  return (animal==='خروف' || animal==='ماعز');
}
function expiryDate(fromISO, animal){
  const d = new Date(fromISO);
  d.setDate(d.getDate() + (is14day(animal)?14:21));
  const y=d.getFullYear(), m=pad(d.getMonth()+1), dd=pad(d.getDate());
  return `${y}-${m}-${dd}`;
}
function buildFoodLabelHTML(it){
  const logo = state.settings.labelImg || state.settings.brandImg || '';
  const plantName = it.site || '';
  const prod = dateOnly(it.dt);
  const exp  = expiryDate(it.dt, it.animal);
  return `
    <div class="food-label-page">
      <div class="food-label">
        <div style="display:flex;align-items:center;gap:.08in; margin-bottom:.06in">
          ${logo?`<img class="logo" src="${logo}">`:''}
          <div class="plant-name">${plantName}</div>
        </div>
        <div class="food-label-wrapper">
          <div class="box"><div class="ttl">نوع الذبيحة</div><div class="val">${it.animal}</div></div>
          <div class="box"><div class="ttl">نوع التقطيع</div><div class="val">${it.cut}</div></div>
          <div class="box"><div class="ttl">تاريخ الإنتاج</div><div class="val">${prod}</div></div>
          <div class="box"><div class="ttl">تاريخ الانتهاء</div><div class="val">${exp}</div></div>
          <div class="sticker" style="grid-row:1 / span 2">${it.sticker}</div>
          <div class="box"><div class="ttl">—</div><div class="val" style="visibility:hidden">.</div></div>
          <div class="box"><div class="ttl">—</div><div class="val" style="visibility:hidden">.</div></div>
          <div class="box"><div class="ttl">—</div><div class="val" style="visibility:hidden">.</div></div>
        </div>
        <div class="food-footer">لأي ملاحظة يُرجى مراجعة المسلخ</div>
      </div>
    </div>
  `;
}
function printFoodLabel(){
  if(state.items.length===0){ alert('لا توجد بيانات مدخلة'); return; }
  const it = state.items[state.items.length-1];
  doPrintHtml(buildFoodLabelHTML(it));
}

/* ============= إعدادات: مواقع/بادئة/أسعار/مستخدمون/صور ============= */
function addUser(){
  const id = $('#setUserId').value.trim();
  const role = $('#setRole').value;
  if(!id) return;
  const ex = state.settings.users.find(u=>u.id===id);
  if(ex){ ex.role=role; } else { state.settings.users.push({id, role}); }
  renderUsers(); saveSession();
}
function renderUsers(){
  const tb = $('#usersTable tbody'); tb.innerHTML='';
  state.settings.users.forEach(u=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.id}</td><td>${u.role}</td>`; tb.appendChild(tr);
  });
}
function addSite(){
  const name = $('#setSite').value.trim();
  const prefix = $('#setPrefix').value.trim();
  if(!name) return;
  const ex = state.settings.sites.find(s=>s.name===name);
  if(ex){ ex.prefix=prefix; } else { state.settings.sites.push({name, prefix}); }
  renderSites(); fillSites($('#site')); fillSites($('#clientsSite')); fillSites($('#statsSite'));
  saveSession();
}
function renderSites(){
  const tb = $('#sitesTable tbody'); tb.innerHTML='';
  state.settings.sites.forEach(s=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.name}</td><td>${s.prefix||''}</td>`; tb.appendChild(tr);
  });
}
$('#setAnimal').addEventListener('change', e=>{
  $('#setAnimalOther').classList.toggle('hidden', e.target.value!=='أخرى…');
});
function addPriceMap(){
  let animal = $('#setAnimal').value;
  if(animal==='أخرى…'){ animal = $('#setAnimalOther').value.trim(); if(!animal) return; }
  const cut = $('#setCut').value;
  const price = parseFloat($('#setPrice').value || 0);
  state.settings.priceMap[animal+'|'+cut] = price;
  renderPrices(); saveSession();
}
function renderPrices(){
  const tb = $('#pricesTable tbody'); tb.innerHTML='';
  Object.entries(state.settings.priceMap).forEach(([k,price])=>{
    const [a,c]=k.split('|');
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${a}</td><td>${c}</td><td>${price}</td>`; tb.appendChild(tr);
  });
}

/* رفع الصور من الملفات */
function uploadImage(evt, key){
  const file = evt.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    const url = e.target.result;
    if(key==='splash'){ state.settings.splashImg=url; $('#splashImg').src=url; }
    if(key==='login'){ state.settings.loginImg=url; $('#loginImg').src=url; }
    if(key==='entry'){ state.settings.entryImg=url; $('#entryImg').src=url; }
    if(key==='clients'){ state.settings.clientsImg=url; $('#clientsImg').src=url; }
    if(key==='stats'){ state.settings.statsImg=url; $('#statsImg').src=url; }
    if(key==='label'){ state.settings.labelImg=url; }
    if(key==='brand'){ state.settings.brandImg=url; $('#brandImg').src=url; }
    saveSession();
  };
  reader.readAsDataURL(file);
}

/* رسم جداول الإعدادات عند فتح الشاشة */
document.addEventListener('click', (e)=>{
  if(e.target.closest('[onclick*="screenSettings"]')){
    renderUsers(); renderSites(); renderPrices();
  }
});

/* تحديث الوقت الحي */
setInterval(()=>{ $('#nowInfo').textContent = new Date().toLocaleString('ar-EG'); }, 1000);

/* ============= تهيئة بعد التحميل ============= */
window.addEventListener('load', ()=>{
  // ضبط صورة الترحيب الافتراضية من الرابط المعطى
  if(!state.settings.splashImg){
    state.settings.splashImg = "https://static.vecteezy.com/system/resources/previews/043/524/239/non_2x/camel-head-silhouette-without-background-vector.jpg";
    $('#splashImg').src = state.settings.splashImg;
  }
  renderUsers(); renderSites(); renderPrices();
});
</script>

</body>
</html>
